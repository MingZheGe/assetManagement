<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>手机H5行情</title>
    <link rel="stylesheet" href="../tools.css?version=1504" />
    <link rel="stylesheet" href="../font/iconfont.css">
    <link rel="stylesheet" href="hengping.css">
</head>  
<body>
    <div id="main" style="position: relative;">
        <div class="phone-symbol-title">
            <div class="symbol-name">
                <h1></h1>
                <span></span>
            </div>
            <div class="symbol-price">
                <h1>--.--</h1>
                <span>--.--</span>
                <div style="clear: both;"></div>
            </div>
            <div class="symbol-item">
                <ul>
                    <li>年K</li>
                    <li>月K</li>
                    <li>周K</li>
                    <li class="activeLi">日K</li>
                    <li class="minute-Kline">分时</li>
                </ul>
               <!-- <span>分时</span>-->
                <div style="clear: both;"></div>
            </div>
            <div style="clear: both;"></div>
        </div>

        <div id="kline" style="width: 900px;height:400px;position: relative;float: left;top: -16px;"></div>
        <div id="minuteKline" style="width: 900px;height:400px;position: relative;float: left;top: -16px;"></div>

        <div class="phone-right">
            <ul class="ul-one">
                <li class="no-right">不复权</li>
                <li class="pre-right active-right">前复权</li>
                <li class="append-right">后复权</li>
            </ul>
            <ul class="ul-two">
            </ul>
        </div>
        <div class="right-minute">
            <ul class="minute-tab">
                <li class="table-sell active-minute">五档</li>
                <li class="table-buy">明细</li>
            </ul>
            <div id="minuteFive" class="table-minute">
                <table class="table-one">
                </table>
                <table class="table-two">
                </table>
            </div>

            <div id="minute" class="table-minute">
                <table class="table-info">
                </table>
            </div>
        </div>
    </div>

<script type="text/javascript" src="../umychart.macro.js?version=1530"></script>
<script type="text/javascript" src="../umychart.js?version=1503"></script>
<script type="text/javascript" src="../umychart.stock.js?version=1463"></script>
<script type="text/javascript" src="rem.js"></script>
<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script>
function getURLParams(name) 
{
	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
	var r = window.location.search.substr(1).match(reg);
	if (r != null) return decodeURI(r[2]);
	return null;
}

//全局的环境变量
var JSEnvironment=
{
    IsForceLandscape:true,  //是否强制横屏
    Symbol:'600000.sh',     //股票代码
    //Symbol:'000001.sz',     //股票代码
    KLineIndex:['均线','VOL','MACD','KDJ','BOLL'],  //K线指标

    MinuteChart:null,       //走势图
    MinuteOption:null,

    HistoryChart:null,      //K线图
    HistoryOption:null,
    
    StockCache:null            //股票数据
};

//加载环境变量
function LoadEnvironment()
{
    var symbol=getURLParams('symbol');
    if (symbol!=null) JSEnvironment.Symbol=symbol;

    var strIndex=getURLParams('index');
    if(strIndex)
    {
        var aryIndex = strIndex.split(',');
        if (aryIndex.length>0) JSEnvironment.KLineIndex=aryIndex;
    }

    //走势图配置
    JSEnvironment.MinuteOption=
    {
        Type:'分钟走势图',
        Symbol:JSEnvironment.Symbol,
        IsAutoUpate:true,       //是自动更新数据

        IsShowRightMenu:false,   //右键菜单
        IsShowCorssCursorInfo:false,    //是否显示十字光标的刻度信息

        Border: //边框
        {
            Left:50,    //左边间距
            Right:75,     //右边间距
            Top:20
        },

        KLineTitle: //标题设置
        {
            IsShowName:false,       //不显示股票名称
            IsShowSettingInfo:false //不显示周期/复权
        },

        Frame:  //子框架设置,刻度小数位数设置
        [
            {SplitCount:5,StringFormat:1},
            {SplitCount:3,StringFormat:1}
        ]
    };

    //K线图配置
    JSEnvironment.HistoryOption=
    {
        Type:'历史K线图',
        Windows:
        [
            {"Index":"均线","Modify":false,"Change":false,TitleHeight:16},
            {"Index":"VOL","Modify":false,"Change":false,TitleHeight:16}
        ],   //窗口指标
        Symbol:JSEnvironment.Symbol,
        IsAutoUpate:true,       //是自动更新数据

        IsShowRightMenu:false,   //右键菜单
        IsShowCorssCursorInfo:false,    //是否显示十字光标的刻度信息

        KLine:
        {
            DragMode:1,                 //拖拽模式 0 禁止拖拽 1 数据拖拽 2 区间选择
            Right:1,                    //复权 0 不复权 1 前复权 2 后复权
            Period:0,                   //周期 0 日线 1 周线 2 月线 3 年线
            MaxReqeustDataCount:1000,   //数据个数
            PageSize:50,                 //一屏显示多少数据
            IsShowTooltip:false              //是否显示K线提示信息
        },

        KLineTitle: //标题设置
        {
            IsShowName:false,       //不显示股票名称
            IsShowSettingInfo:false //不显示周期/复权
        },

        Border: //边框
        {
            Left:45,    //左边间距
            Right:5,     //右边间距
            Top:20
        },

        Frame:  //子框架设置
        [
            {SplitCount:3,StringFormat:1},
            {SplitCount:3,StringFormat:1}
        ]
    };
}

function UpdateForceLandscape()
{
    if (JSEnvironment.MinuteChart) JSEnvironment.MinuteChart.ForceLandscape(JSEnvironment.IsForceLandscape);
    if (JSEnvironment.HistoryChart) JSEnvironment.HistoryChart.ForceLandscape(JSEnvironment.IsForceLandscape);
}

//更新右边指标列表
function UpdateIndexListUI()
{
    for(var i in JSEnvironment.KLineIndex)
    {
        var item=JSEnvironment.KLineIndex[i];
        $(".ul-two").append("<li>" + item + "</li>");
    }
}

$(window).resize(resizeCanvas);

function resizeCanvas()
{
    var body = document.getElementsByTagName('body')[0];
    var html = document.getElementsByTagName('html')[0];
    var divMain=document.getElementById('main');
    var divKline=document.getElementById('kline');
    var minuteKline=document.getElementById('minuteKline');
    var width = body.clientWidth;
    var height =  body.clientHeight;
    var maxDiv = width > height ? width : height;
    var minDiv = width > height ? height: width;
    var max = width > height ? (width - 65) : (height - 65);
    var min = width > height ? (height - 40): (width - 40);
    var maxMinute = width > height ? (width - 140) : (height - 140);
    divMain.style.left = (max - min) / 2;
    divMain.style.top = (min - max) / 2;
    divMain.style.width=maxDiv + 'px';
    divMain.style.height=minDiv + 'px';
    divKline.style.width=max + 'px';
    divKline.style.height=min + 'px';
    minuteKline.style.width=maxMinute + 'px';
    minuteKline.style.height=min + 'px';
    if (divKline.JSChart) divKline.JSChart.OnSize();
    if (minuteKline.JSChart) minuteKline.JSChart.OnSize();
}

$(function ()
{
    LoadEnvironment();
    UpdateIndexListUI();

    function UpdateUI(id,arySymbol,dataType,jsStock){
        if(id == "main"){
            UpdateMain(jsStock);
        }else if(id == "minute"){
            updateMinute(jsStock);
        }else if(id == "minuteFive"){
            updateMinuteFive(jsStock);
        }
    }

    function UpdateMain(jsStock)
    {
        var read=jsStock.GetStockRead('main',UpdateUI);        //获取一个读取数据类,并绑定id,和更新数据方法
        var name=read.Get(JSEnvironment.Symbol,STOCK_FIELD_NAME.NAME);            //读取一个股票的数据(如果缓存过数据,可以获取到数据,没有缓存过为null)
        var price=read.Get(JSEnvironment.Symbol,STOCK_FIELD_NAME.PRICE);
        var increase=read.Get(JSEnvironment.Symbol,STOCK_FIELD_NAME.INCREASE);
        read.EndRead();

        if(increase != undefined){
            if(increase < 0){
                $(".symbol-price").addClass("symbolDown");
            }else if(increase > 0){
                $(".symbol-price").addClass("symbolUp");
            }else{
                $(".symbol-price").addClass("symbolAve");
            }
        }

        $(".symbol-name h1").html(name==null ? "----" : name);
        $(".symbol-name span").html(JSEnvironment.Symbol.substring(0,6));
        $(".symbol-price h1").html(Number(price).toFixed(2));
        $(".symbol-price span").html(Number(increase).toFixed(2) + "%");
    }

    function updateMinuteFive(jsStock) {
        var read=jsStock.GetStockRead('minuteFive',UpdateUI);        //获取一个读取数据类,并绑定id,和更新数据方法
        var buyData=read.Get(JSEnvironment.Symbol,STOCK_FIELD_NAME.BUY5);
        var sellData=read.Get(JSEnvironment.Symbol,STOCK_FIELD_NAME.SELL5);
        var yClose=read.Get(JSEnvironment.Symbol,STOCK_FIELD_NAME.YCLOSE);
        read.EndRead();

        if (sellData && sellData.length==5)
        {
            $(".table-one").html("");
            for(var i in sellData){
                var dataN=sellData[i];
                var arr=["卖一","卖二","卖三","卖四","卖五"];
                var tr1 = "<tr><td>"+arr[i]+"</td><td class='color-change'>"+dataN.Price.toFixed(2)+"</td><td>"+dataN.Vol+"</td></tr>";
                $(".table-one").prepend(tr1);

                if(dataN.Price > yClose){
                    $(".table-one .color-change").addClass("symbolUp");
                }else if(dataN.Price < yClose){
                    $(".table-one .color-change").addClass("symbolDown");
                }else{
                    $(".table-one .color-change").addClass("symbolAve");
                }
            }
        }
        if (buyData && buyData.length==5)
        {
            $(".table-two").html("");
            for(var i in buyData){
                var dataM=buyData[i];
                var arr=["买一","买二","买三","买四","买五"];
                var tr2 = "<tr><td>"+arr[i]+"</td><td class='color-change'>"+dataM.Price.toFixed(2)+"</td><td>"+dataM.Vol+"</td></tr>";
                $(".table-two").append(tr2);

                if(dataM.Price - yClose >0){
                    $(".table-two .color-change").addClass("symbolUp");
                }else if(dataM.Price - yClose < 0){
                    $(".table-two .color-change").addClass("symbolDown");
                }else{
                    $(".table-two .color-change").addClass("symbolAve");
                }
            }
        }
    }

    function updateMinute(jsStock) {
        var read=jsStock.GetStockRead('minute',UpdateUI);        //获取一个读取数据类,并绑定id,和更新数据方法
        var deal=read.Get(JSEnvironment.Symbol,STOCK_FIELD_NAME.DEAL);
        var yClose=read.Get(JSEnvironment.Symbol,STOCK_FIELD_NAME.YCLOSE);
        read.EndRead();

        if (deal)
        {
            $(".table-info").html("");
            for(var i in deal){
                var item =deal[i];
                var timer=item.Time;
                timer = timer.toString();
                var timeStr,newTime;
                if(timer.length == 5){
                    timeStr = "0" + timer;
                }else if(timer.length == 6){
                    timeStr = timer;
                }
                newTime = timeStr.substring(0,2) + ":" + timeStr.substring(2,4);

                var trd = "<tr><td>"+newTime+ "</td><td class='color-change'>"+item.Price.toFixed(2)+"</td><td>"+item.Vol+"</td></tr>";
                $(".table-info").append(trd);

                if(item.Price > yClose){
                    $(".table-info .color-change").addClass("symbolUp");
                }else if(item.Price < yClose){
                    $(".table-info .color-change").addClass("symbolDown");
                }else{
                    $(".table-info .color-change").addClass("symbolAve");
                }
            }
        }
    }

    

    $(".table-sell").click(function () {
        $("#minute").hide();
        $("#minuteFive").show();
        $(".table-sell").addClass("active-minute").siblings().removeClass("active-minute");

    });

    $(".table-buy").click(function () {
        $("#minute").show();
        $("#minuteFive").hide();
        $(".table-buy").addClass("active-minute").siblings().removeClass("active-minute");

    });

    //复权切换
    $(".ul-one li").click(function () {
        var num = $(this).index();
        JSEnvironment.HistoryChart.ChangeRight(num);
        $(this).addClass("active-right").siblings().removeClass("active-right");
    });

    //周期切换
    $(".symbol-item li").click(function () {
        $("#kline").show();
        $(".phone-right").show();
        var period = 2 - ($(this).index() - 1);
        if (JSEnvironment.HistoryChart==null)
        {
            JSEnvironment.HistoryChart=JSChart.Init(document.getElementById('kline'));         //初始化K线图
            JSEnvironment.HistoryOption.KLine.Period=period;
            JSEnvironment.HistoryChart.SetOption(JSEnvironment.HistoryOption);
            UpdateForceLandscape(); 
        }
        else
        {
            JSEnvironment.HistoryChart.ChangePeriod(period);
        }

        $(this).addClass("activeLi").siblings().removeClass("activeLi");
        $("#minuteKline").hide();
        $(".right-minute").hide();
    });

    //指标切换
    $(".ul-two li:first-child").addClass("active-right");
    $(".ul-two li").click(function () {
        var text = $(this).text();
        JSEnvironment.HistoryChart.ChangeIndex(1,text);
        $(this).addClass("active-right").siblings().removeClass("active-right");
    });

    $(".minute-Kline").click(function () {
        $("#kline").hide();
        $(".phone-right").hide();

        if (JSEnvironment.MinuteChart==null)
        {
            JSEnvironment.MinuteChart=JSChart.Init(document.getElementById('minuteKline'));  // 初始化走势图
            JSEnvironment.MinuteChart.SetOption(JSEnvironment.MinuteOption);
            UpdateForceLandscape();     
        }

        $("#minuteKline").show();
        $(".right-minute").show();
    });

    function hengshuping()
    {
        if(window.orientation==180||window.orientation==0){
            JSEnvironment.IsForceLandscape=true;
            UpdateForceLandscape();
        }
        if(window.orientation==90||window.orientation==-90){
            JSEnvironment.IsForceLandscape=false;
            UpdateForceLandscape();
        }
    }

    window.addEventListener("onorientationchange" in window ? "orientationchange" : "resize", hengshuping, false);

    JSEnvironment.StockCache=JSStock.Init();           //初始化数据控件
    UpdateMain(JSEnvironment.StockCache);
    updateMinute(JSEnvironment.StockCache);
    updateMinuteFive(JSEnvironment.StockCache);
    JSEnvironment.StockCache.ReqeustData();

    $(".symbol-item li").eq(3).trigger('click');    //点击日线

    resizeCanvas();
})



</script>  
</body>  
</html>