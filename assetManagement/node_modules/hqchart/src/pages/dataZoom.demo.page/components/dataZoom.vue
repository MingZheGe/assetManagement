<template>
  <div class="miniMap">
    <div class="splitLines">
      <div class="lineAndName" v-for="(lineName, index) in lineAndNameAry" :key='index' :style="{width: lineName.width}">
        <div class="line" v-if='index != 0'></div>
        <div class="name" v-if='index != 0'>{{lineName.name}}</div>
      </div>
    </div>
    <div class="slideBar" :style="{left:slideBarStyle.left+'px',right:slideBarStyle.right+'px'}" @mousedown='commonMouseDown'>
      <div class="sbLeft" @mousedown.stop='commonMouseDown'></div>
      <div class="sbRight" @mousedown.stop='commonMouseDown'></div>
    </div>
    <!-- <div class="slideBarWrap">
      
    </div> -->
    
  </div>
</template>

<script>
  export default {
    props: ['lineAndNameAry'],
    data () {
      return {
        // miniMapStyle: {
        //   height: "49.73px", 
        //   left: "59px", 
        //   right: "65px",  
        //   bottom: "20px"
        // },
        isSlideBarMove: false,
        isLeftMove: false,
        isRightMove: false,
        slideBarStyle: {
          left: 0, 
          right: 0,
          MaxWidth: 0,
          width: 0
        },
        PointPosition: {
          x: 0,
          y: 0
        },
        beforeMoveX: 0, //滑动前的位置-左
        beforeMoveXRight: 0 //滑动前的位置-右
        // lineAndNameAry: [
        // ]
      }
    },
    created () {
      let totalWidth = 0;
      this.lineAndNameAry.forEach(item => {
        totalWidth += item.dataCount;
      });
      this.lineAndNameAry.forEach(item => {
        item.width = parseInt(item.dataCount / totalWidth * 100) + '%';
      });

      const _this = this;
      document.onmouseup = function(e) {
        _this.commonMouseUp(e);
      }
    },
    mounted () {

    },
    methods: {
      OnSize (boxWidth,startPosition,endPosition) {
        this.slideBarStyle.MaxWidth = boxWidth;
        this.slideBarStyle.left = parseInt(boxWidth * (1- startPosition));
        this.slideBarStyle.right = parseInt(boxWidth * (1 - endPosition));
        this.slideBarStyle.width = boxWidth - this.slideBarStyle.left - this.slideBarStyle.right;
        // console.log('OnSize::left,right,width:',this.slideBarStyle);
        this.beforeMoveX = this.slideBarStyle.left;
        this.beforeMoveXRight = this.slideBarStyle.right;
      },
      getHeight(){
        return 50;
      },
      changeSlideBarPosition () {
        
      },
      slideBarMouseMove (e) {
        if(this.isSlideBarMove) {
          let offsetWidth = e.clientX - this.PointPosition.x; //左移为负值
          this.PointPosition.x = e.clientX;
          // console.log('偏移：',offsetWidth);
          const oldLeft = this.slideBarStyle.left;
          const oldRight = this.slideBarStyle.right;
          this.slideBarStyle.left += offsetWidth;
          this.slideBarStyle.right -= offsetWidth;
          // let realOffset = -offsetWidth;
          if(this.slideBarStyle.left < 0) {
            this.slideBarStyle.left = 0;
            this.slideBarStyle.right = this.slideBarStyle.MaxWidth - this.slideBarStyle.width;
            // realOffset = oldLeft;
          }
          if(this.slideBarStyle.right < 0) {
            this.slideBarStyle.right = 0;
            this.slideBarStyle.left = this.slideBarStyle.MaxWidth - this.slideBarStyle.width;
            realOffset = oldRight;
          }
        }
      },
      sbLeftMouseMove (e) {
        if(this.isLeftMove) {
          let offsetWidth = e.clientX - this.PointPosition.x;
          this.PointPosition.x = e.clientX;
          // console.log('偏移：',offsetWidth);
          this.slideBarStyle.left += offsetWidth;
          if(this.slideBarStyle.left < 0) {
            this.slideBarStyle.left = 0;
          }else if(this.slideBarStyle.left + 10 > this.slideBarStyle.MaxWidth - this.slideBarStyle.right) { //sbLeft 与 sbRight紧挨着的位置，left与right最小间隔是10px
            this.slideBarStyle.left = this.slideBarStyle.MaxWidth - this.slideBarStyle.right - 10
          }
          // console.log('偏移：', this.slideBarStyle.left, this.slideBarStyle.right);
        }
      },
      sbRightMouseMove (e) {
        if(this.isRightMove){
          let offsetWidth = e.clientX - this.PointPosition.x;
          this.PointPosition.x = e.clientX;
          // console.log('偏移：',offsetWidth);
          this.slideBarStyle.right -= offsetWidth;
          if(this.slideBarStyle.right < 0) {
            this.slideBarStyle.right = 0;
          }else if(this.slideBarStyle.right + 10 > this.slideBarStyle.MaxWidth - this.slideBarStyle.left){
            this.slideBarStyle.right = this.slideBarStyle.MaxWidth - this.slideBarStyle.left - 10;
          }
          console.log('偏移：', this.slideBarStyle.left, this.slideBarStyle.right);
        }
      },
      commonMouseDown (e) {
        if(e.target.className == "slideBar") { //点击透明色互动块，保存初始宽度
          this.slideBarStyle.width = this.slideBarStyle.MaxWidth - this.slideBarStyle.left - this.slideBarStyle.right;
          this.isSlideBarMove = true;
        }else if(e.target.className == "sbLeft"){
          this.isLeftMove = true;
        }else if(e.target.className == "sbRight"){
          this.isRightMove = true;
        }
        
        this.PointPosition.x = e.clientX;
        // this.PointPosition.y = e.clientY;
        // console.log('down：：',e,e.target, e.clientX, e.clientY);
        
        document.onmousemove= (ev) => { //写在mousedown,保证快速拖动时扔能有效
          if(e.target.className == "slideBar"){
            this.slideBarMouseMove(ev);
          }else if(e.target.className == "sbLeft"){
            this.sbLeftMouseMove(ev);
          }else if(e.target.className == "sbRight"){
            this.sbRightMouseMove(ev);
          }
        };

      },
      commonMouseUp (e) {
        // console.log('哪个移动，',this.isSlideBarMove,);
        let realOffset = 0;
        let movePercent = 0;
        let direction = '';
        let isCountChange = 'no';
        if(this.isSlideBarMove){
          console.log('块 滑动');
          realOffset = this.slideBarStyle.left - this.beforeMoveX;
          if(realOffset < 0){
            realOffset = -realOffset;
            direction = 'toleft';
          }else{
            direction = 'toright';
          }
          
        }else if(this.isLeftMove){
          console.log('左 滑动');
          realOffset = this.slideBarStyle.left - this.beforeMoveX;
          if(realOffset < 0){
            realOffset = -realOffset;
            direction = 'toleft';
            isCountChange = 'increase';
          }else{
            direction = 'toright';
            isCountChange = 'reduce';
          }
          
        }else if(this.isRightMove){
          console.log('右 滑动');
          realOffset = this.slideBarStyle.right - this.beforeMoveXRight;
          if(realOffset < 0) {
            realOffset = -realOffset;
            direction = 'toright';
            isCountChange = 'increase';
          }else{
            direction = 'toleft';
            isCountChange = 'reduce';
          }
        }
        movePercent = (realOffset / this.slideBarStyle.MaxWidth).toFixed(2);
        this.isSlideBarMove = false;
        this.isLeftMove = false;
        this.isRightMove = false;
        this.beforeMoveX = this.slideBarStyle.left; //保存滑动前位置
        this.beforeMoveXRight = this.slideBarStyle.right; //保存滑动前位置

        let moveInfo = {
          movePercent, 
          direction, 
          isCountChange
        };
        console.log('moveInfo::', realOffset, moveInfo);
        this.$emit('move', moveInfo);
        // console.log('isSlideBarMove::', this.isSlideBarMove);
        
      }
    }
  }
</script>

<style lang="less">
  html,body{ /*鼠标移动时禁止选中文字*/
    -moz-user-select: none; 
    -khtml-user-select: none; 
    user-select: none;
  }
  .miniMap{
    position: absolute;
    bottom: 0;
    z-index: 30;
    overflow: visible;
    /* clear: both; */
    border: 1px solid #ccc;
    font: 14px 'Microsoft Yahei';
    height: 50px;
    width: 100%;
    left: 0;
    bottom: 0;
    box-sizing: border-box;

    .splitLines{
      height: 100%;
      display: flex;

      .lineAndName{
        width: 20%;
        height: 100%;
        position: relative;
      }

      .line {
        position: absolute;
        top: 25px;
        bottom: 0;
        width: 1px;
        background-color: #333;
      }

      .name {
        position: absolute;
        top: 25px;
        left: 5px;
        font-size: 12px;
        color: #333;
      }
    }

    .slideBarWrap{
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background-color: transparent;
    }

    .slideBar{
      position: absolute;
      height: 100%;
      left: 0;
      right: 0;
      top: 0;
      background-color: rgba(0, 0, 0, 0.1);
      cursor: move;
      transition: all .5 ease;

      .sbLeft,
      .sbRight {
        position: absolute;
        cursor: w-resize;
        width: 10px;
        height: 50%;
        top: 25%;
        background-color: #999999;
      }

      .sbLeft {
        left: -5px;
      }
      .sbRight{
        right: -5px;
      }
    }
  }
</style>