<template>
  <div class="demoWrap" ref='demoWrap'>
    <div id="kline" ref='kline'></div>
    <DataZoom ref='dataZoom' 
      :lineAndNameAry='lineAndNameAry'
      :startPosition='startPosition'
      :endPosition='endPosition'
      @move='moveChart'
    ></DataZoom>
  </div>
</template>

<script>
  import DataZoom from './components/dataZoom.vue'
  import JSCommon from '../../jscommon/umychart.vue/umychart.vue.js'
  function DefaultData() {}
  DefaultData.GetKlineOption = function(symbol){
    let data = {
        Type: '历史K线图',
        Windows: [
            { Index: "均线",Modify:false,Change:false},
            { Index: "VOL",Modify:false,Change:false },
        ], //窗口指标
        Symbol: symbol,
        IsAutoUpate: true, //是自动更新数据

        IsShowRightMenu: false, //右键菜单

        KLine: {
            DragMode: 1, //拖拽模式 0 禁止拖拽 1 数据拖拽 2 区间选择
            Right: 1, //复权 0 不复权 1 前复权 2 后复权
            Period: 0, //周期 0 日线 1 周线 2 月线 3 年线
            MaxReqeustDataCount: 3000, //日线数据最近1000天
            MaxRequestMinuteDayCount: 15,    //分钟数据最近15天
            PageSize: 50, //一屏显示多少数据
            IsShowTooltip: false //是否显示K线提示信息
        },

        KLineTitle: //标题设置
        {
            IsShowName: false, //不显示股票名称
            IsShowSettingInfo: false //不显示周期/复权
        },

        Border: //边框
        {
            Left: 0, //左边间距
            Right: 1, //右边间距
            Top: 20
        },

        Frame: //子框架设置
        [
            { SplitCount: 3, StringFormat: 0 },
            { SplitCount: 3, StringFormat: 0 },
            { SplitCount: 3, StringFormat: 0 },
            { SplitCount: 3, StringFormat: 0 }
        ]
    };
    return data;
  }

  export default {
    data () {
      return {
        Kline:{
          JSChart:null,
          // IsShow:false,
          Option:null
        },
        Symbol: '600000.sh',
        lineAndNameAry: [],
        PageSize: 50, //初始一屏展示的数据
        startPosition: 0.5,
        endPosition: 1,
        lineCount: 0
      }
    },
    created () {
      this.Kline.Option = DefaultData.GetKlineOption(this.Symbol);
    },
    mounted () {
      this.OnSize();
      window.onresize = () => {
        this.OnSize();
      };

      this.createKlineChart(0);
    },
    components: {
      DataZoom
    },
    watch: {
      startPosition: function(){
        this.OnSize();
      }
    },
    methods: {
      OnSize(){
        var width = this.$refs.demoWrap.clientWidth;
        var height = this.$refs.demoWrap.clientHeight;

        var chartHeight = height - this.$refs.dataZoom.getHeight();
        console.log(height+', ',chartHeight);
        this.$refs.kline.style.width = width + 'px';
        this.$refs.kline.style.height = chartHeight + 'px';

        this.$refs.dataZoom.OnSize(width,this.startPosition,this.endPosition);

      },
      IncreasLeftShowCount (bIncrease,step) //左边增加或减少
      {
          // var step=document.getElementById("left_zoom_step").value;

          if (bIncrease==true)
          {
              var obj={ID:8, Step:parseInt(step) };
              this.Kline.JSChart.JSChartContainer.ChartOperator(obj);
          }
          else
          {
              var obj={ID:7, Step:parseInt(step)};
              this.Kline.JSChart.JSChartContainer.ChartOperator(obj);
          }
          
      },

      IncreasRightShowCount (bIncrease,step) //右边边增加或减少
      {
          // var step=document.getElementById("right_zoom_step").value;

          if (bIncrease==true)    //放大
          {
              var obj={ID:10, Step:parseInt(step) };
              this.Kline.JSChart.JSChartContainer.ChartOperator(obj);
          }
          else        //缩小
          {
              var obj={ID:9, Step:parseInt(step)};
              this.Kline.JSChart.JSChartContainer.ChartOperator(obj);
          }
          
      },
      moveChart(moveInfo){
        let {movePercent, direction, isCountChange} = moveInfo;
        console.log('moveChart::',movePercent,direction, isCountChange);
        let step = this.lineCount * movePercent;
        switch(isCountChange){
          case 'no':
            console.log('整体移动，step:',step);
            if(direction == 'toleft') { //鼠标向左，图形向右
              this.MoveRight(step);
            }else{
              this.MoveLeft(step);
            }
            break;
          case 'increase':
            console.log('整体增加，step:',step);
            if(direction == 'toleft'){
              this.IncreasLeftShowCount(true,step);
            }else{
              this.IncreasRightShowCount(true,step);
            }
            break;
          case 'reduce':
            console.log('整体减少，step:',step);
            if(direction == 'toleft'){
              this.IncreasRightShowCount(false,step);
            }else{
              this.IncreasLeftShowCount(false,step);
            }
            break;
        }
      },
      //接受到历史数据
      OnRecvHistoryData (event,data,obj)
      {
          console.log("[KLineChart::OnRecvHistoryData] data=", data);
          var hisData=data.HistoryData;
          var count=hisData.Data.length;
          this.lineCount = count;
          // let yearAry = [];
          hisData.Data.forEach(item => {
            let year = item.Date.toString().substring(0,4);
            // debugger;
            if(this.lineAndNameAry.find(lineName => lineName.name == year) != undefined){
              this.lineAndNameAry.find(lineName => lineName.name == year).dataCount++;
            }else{
              this.lineAndNameAry.push(
                {
                  dataCount: 0,
                  width: '',
                  name: year
                }
              );
            }
          });
          // console.log('年分割：',this.lineAndNameAry);
          this.startPosition = Number(this.PageSize / count).toFixed(2);
          // debugger;
          // console.log('年分割：',this.startPosition);
          // document.getElementById("kline_count").innerText=`K线个数${count}`;
      },

      OnDrawFinish (event,data,obj)
      {
          var showCount=this.Kline.JSChart.JSChartContainer.Frame.SubFrame[0].Frame.XPointCount; //获取一屏显示的数据个数
          var count=this.Kline.JSChart.JSChartContainer.ChartPaint[0].Data.Data.length;
          var offset=this.Kline.JSChart.JSChartContainer.ChartPaint[0].Data.DataOffset;

          // document.getElementById("kline_showcount").innerText=`当前屏数据个数${showCount}`;
          // document.getElementById("kline_count").innerText=`K线个数${count}`;
          // document.getElementById("kline_offset").innerText=`起始数据索引${offset}`;
          
      },
      MoveLeft (step)
      {
          // var step=document.getElementById("left_step").value;

          var obj = { ID: 1, Step:parseInt(step) };
          this.Kline.JSChart.JSChartContainer.ChartOperator(obj);
      },
      MoveRight (step)
      {
          // var step=document.getElementById("right_step").value;

          var obj = { ID: 2, Step:parseInt(step) };
          this.Kline.JSChart.JSChartContainer.ChartOperator(obj);
      },
      createKlineChart (value) {
        this.Kline.JSChart = JSCommon.JSChart.Init(document.getElementById('kline'));
        this.Kline.Option.KLine.PageSize = this.PageSize;
        this.Kline.Option.KLine.Period = value;
        this.Kline.JSChart.SetOption(this.Kline.Option);

        //选中图形事件
        this.Kline.JSChart.AddEventCallback( {
          event:JSCommon.JSCHART_EVENT_ID.RECV_HISTROY_DATA, 
          callback:(event,data,obj)=>{ this.OnRecvHistoryData(event,data,obj); }
        });


        this.Kline.JSChart.AddEventCallback({ 
          event:JSCommon.JSCHART_EVENT_ID.CHART_STATUS, 
          callback:(event,data,obj)=>{ this.OnDrawFinish(event,data,obj); }
        });
      }
    }
  }

</script>

<style lang="less">
  html,body{
    width: 100%;
    height: 100%;  
  }
.demoWrap{
  width: 900px;
  height: 700px;
  position: relative;
  margin: 0 auto;
  margin-top: 50px;
}
</style>