<template>
  <div class="stockdeallastest" ref="stockdeallastest">
    <div class="topBox" ref="topBox">
      <div class="titleBox" ref="titleBox">
        <span>{{name}}</span>
        <span>{{Symbol}}</span>
        <span>成交明细</span>
      </div>
      <div class="contentTitle">
        <div class="oneBoxTitle" v-for="(item,index) in tableCount" :key="index" ref="oneBoxTitle" :style="{width:+tableWidth+'px'}">
          <div class="">时间</div>
          <div class="">价格</div>
          <div class="">现量</div>
        </div>
      </div>
    </div>
    
    
    <div class="dealContent" ref="dealContent">
      <div v-for="(item,index) in tableCount" :key="index" ref="oneBox" :style="{width:+tableWidth+'px',height:  tableHeight +'px'}" class="oneBox">
        <div class="oneList" v-for="(list,listIndex) in currentData[index]" :key="listIndex" v-if="currentData.length>0">
          <div class="timeCss">{{list.Time}}</div>
          <div class="priceCss" :class="list.PriceColor">{{list.Price}}</div>
          <div class="volBox">
            <span class="volNum">{{parseInt(list.Vol)}}</span>
            <span class="volFlag" :class="list.Flag == 'B' ? 'red' : 'green'">{{list.Flag ? list.Flag :" "}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import urlObj from "../../../utils/urlObj.js"
import StringFormat from "../../../jscommon/umychart.vue/stockstringformat.js";

export default {
  props: ['Symbol'],
  data () {
    return {
      tableWidth:"",
      tableHeight:"",
      pageIndex:1,
      maxPageIndex:2,
      IsReverseData: false,
      LatestDetail: null,
      IsTradeDay:true,
      allDealData:[],
      historyData:[],
      currentData:[],
      Total:0,
      tableCount:1,//一屏可以显示多少列
      everyTableCount:"",//每一列可以显示的个数
      Timer:null,
      Timer2:null,
      startIndex:"",
      endIndex:"",
      change:false,
      yClose:"",
      name:"",
    }
  },
  created: function() {
    document.title = "成交明细";
  },
  mounted () {
    this.onSize();
    var self=this;
    window.onresize = function() { self.onSize() }

    window.addEventListener('mousewheel',this.handleScroll,false)
  },
  methods: {
    UpdateDataShow(start,end){
      var inputData = {
        symbol: this.Symbol,
        start: start,
        end: end
      };

      urlObj.post(urlObj.apiStockDetail,inputData,res=>{
        this.UpdateData(res);
      },error=>{
        console.log(error)
      })
    },
    UpdateData(res) {
      if(res.code != 0){
        return this.$message.error(res.message);
      }
      console.log("res", res);
      this.allDealData = [];
      this.Total = res.count;//实际数据的end
      this.yClose = res.yclose;
      this.name = res.name;
      this.startIndex = res.start;
      this.endIndex = res.count;
      // document.title = this.name + "-" + this.Symbol;
      if (res) {
        res.detail.forEach(item=>{
          var detailItem = {Time:item[0], Price:item[1], Vol:item[2], Amount:item[3] , Flag:''};
          if (item[4]===0) detailItem.Flag='B';
          else if (item[4]===1) detailItem.Flag='S';
          this.allDealData.push(detailItem);
        })

        if(!this.change){
          this.historyData = this.allDealData;
          this.showData(this.allDealData);
        }

        this.TimerData(res.date,res.detail);
      } else {
        this.IsTradeDay = false;
      }
    },
    showData(data){
      var start = data.length - (this.everyTableCount*this.tableCount*this.pageIndex),
      end = data.length - (this.everyTableCount*this.tableCount*(this.pageIndex-1));

      if(this.maxPageIndex == this.pageIndex) {
        start = 0;
        end = this.everyTableCount*this.tableCount;
      }
      if(data.length > 0){
        if(data.length > this.everyTableCount*this.tableCount){
          this.currentData = data.slice(start,end);
        }else{
          this.currentData = data;
        }
        
        this.currentData = this.ChoiceData("", this.currentData, this.yClose); //接收传入的筛选条件
        this.currentData = this.chunk(this.currentData,this.everyTableCount);
      }
      
    },
    TimerData(date){
      console.log("TimerData");
      var now = new Date(),
      year = now.getFullYear(),//年
      month = now.getMonth() + 1,     //月
      day = now.getDate(),
      hh = now.getHours(), //获取系统时，
      mm = now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes(), //分
      ss = now.getSeconds() < 10 ? '0' + now.getSeconds() : now.getSeconds(); //秒

      month = month > 9 ? "" + month : "0" + month;
      day = day > 9 ? '' + day : "0" + day;
      
      var currentDate = year + month + day;
      var time = parseInt(hh + "" + mm + "" + ss);
      if(date == parseInt(currentDate) ){
        if(time>=92500&&time<=114000 || time>=130000&&time<=151000){
          console.log('交易中');
          if(this.Timer) return;
          this.Timer = setInterval(() => {
            console.log("定时器");
            this.UpdateDataShow(this.startIndex,this.endIndex);
          },3000);
        }else{
          console.log('已收盘',time);
          if(this.Timer){
            clearInterval(this.Timer);
            this.Timer = null;
          }

          if(113000 < time && time < 130000){
            this.getRealTime(date);
          }
        }
      }else{
        console.log('未开盘',date,parseInt(currentDate));
        if(this.Timer) clearInterval(this.Timer);
      }
    },
    //中午休市时，定时刷时间
    getRealTime(requstDate){
      this.Timer2 = setInterval(() => {
        console.log("定时器2");
        var now = new Date(),
        hh = now.getHours(), //获取系统时，
        mm = now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes(), //分
        ss = now.getSeconds() < 10 ? '0' + now.getSeconds() : now.getSeconds(); //秒
        var time = parseInt(hh + "" + mm + "" + ss);

        if(time >= 130000){
          this.TimerData(requstDate);
          clearInterval(this.Timer2);
          this.Timer2 = null;
        }
      },3000);
    },
    ChoiceData(num, data, yClose) {
      var dataAry = [];
      // console.log("[stockdeal::ChoiceData]data:", data);
      if (data.length > 0) {
        for (let i = 0; i < data.length; i++) {
          var item = data[i];
          var color = this.FormatValueColor(item.Price, yClose);
          var dataObj = {
            Time: this.processingTime(item.Time),
            Price: StringFormat.StockStringFormat.FormatValueString(
              item.Price,
              2
            ),
            PriceColor: color,
            Vol: parseInt(item.Vol),
            Flag: item.Flag,
            Amount: item.Amount
          };

          if (num != "") {
            if (item.Vol >= num) {
              dataAry.push(dataObj);
            }
          } else {
            dataAry.push(dataObj);
          }
        }
        return dataAry;
      }
    },
    FormatValueColor(currentValue, targetValue) {
      var color = "";
      if (currentValue > targetValue) {
        color = "red";
      } else if (currentValue < targetValue) {
        color = "green";
      } else {
        color = "";
      }
      return color;
    },
    //处理时间
    processingTime(mss) {
      var hours = parseInt(mss / 10000);
      var minutes = parseInt((mss / 100) % 100);
      if (hours < 10) {
        hours = "0" + hours;
      }
      if (minutes < 10) {
        minutes = "0" + minutes;
      }
      return hours + ":" + minutes;
    },
    //分割数组方法
    chunk(arr, size) {
      if(arr&&arr.length>0){
        var arr2=[];
        for(var i=0;i<arr.length;i=i+size){
          arr2.push(arr.slice(i,i+size));
        }
        return arr2;
      }
    },
    onSize(){
      this.pageIndex = 1;
      this.allDealData == [];
      var allBox = this.$refs.stockdeallastest;
      var topBox = this.$refs.topBox;
      var dealContent = this.$refs.dealContent;

      //计算一屏可以展示多少列
      this.tableCount = parseInt(allBox.clientWidth / 225);
      if(this.tableCount < 1) this.tableCount = 1;

      //设置每个table的宽高
      var oneTable = this.$refs.oneTable;
      this.tableWidth = parseInt(allBox.clientWidth/this.tableCount);
      this.tableHeight = (allBox.clientHeight - topBox.clientHeight);

      //一列有多少条数据
      this.everyTableCount = Math.floor(
        this.tableHeight / 20
      );
      if(this.everyTableCount < 0) this.everyTableCount = 1;

      this.UpdateDataShow(0,10000);
    },
    
    handleScroll (e) {
      var direction = e.deltaY>0?'down':'up'; //该语句可以用来判断滚轮是向上滑动还是向下
      console.log("direction",direction);
      if(this.allDealData.length > 0){
        this.change = true;
      }
      
      if(this.change){
        if(direction == 'up'){
          this.pageIndex++;
          this.maxPageIndex = Math.ceil(this.allDealData.length/(this.everyTableCount*this.tableCount));
          if(this.pageIndex > this.maxPageIndex) this.pageIndex = this.maxPageIndex
        }else{
          this.pageIndex--;
          if(this.pageIndex < 1){
            this.pageIndex=1;
            this.change = false;
          } 
        }
        this.showData(this.historyData);
      }
    },
  }
}
</script>

<style lang="less">
.stockdeallastest{
  width: 100%;
  height: 100%;
  background: #141718;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  .topBox{
    height: 60px;
    .titleBox{
      width: 100%;
      height: 32px;
      border-bottom:1px solid #2c3032;
      display: flex;
      justify-content: center;
      align-items: center;
      color:#919aa3;
      font-size: 16px;
      >span{
        margin-right: 5px;
      }
    }
    .contentTitle{
      width: 100%;
      height: 27px;
      display: flex;
      border-bottom:1px solid #2c3032;
      // padding-right:8px;
      // box-sizing: border-box;
      .oneBoxTitle{
        height: 26px;
        display: flex;
        align-items: center;
        border-right:1px solid #2c3032;
        box-sizing: border-box;
        >div{
          width: 33%;
          height: 26px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #919aa3;
          font-size: 12px;
        }
      }
      .oneBoxTitle:last-child{
        border-right:none;
      }
    }
  }
  
  .dealContent{
    width: 100%;
    flex: 1;
    display: flex;
    font-family:Arial,Microsoft YaHei;
    .oneBox{
      border-right:1px solid #2c3032;
      box-sizing: border-box;
      .oneList{
        width:100%;
        height: 20px;
        display: flex;
        align-items: center;
        >div{
          width:33%;
          height:20px;
          line-height: 20px;
          font-size: 12px;
        }
        .timeCss{
          color: #919aa3;
          display: flex;
          justify-content: center;
        }
        .priceCss{
          color:#fff;
          display: flex;
          justify-content: center;
        }
        .volBox{
          display: flex;
          justify-content: flex-end;
          padding-right:4px;
          box-sizing: border-box;
          >span{
            font-size: 12px;
          }
          .volNum{
            color: #d8dfe7;
            padding-right:4px;
          }
        }
        
      }
    }
    .oneBox:last-child{
      border-right:none;
    }
  }

  .red{
    color: #ff5c5c !important;
  }
  .green{
    color: #39e365 !important;
  }
}
</style>