<template>
  <div class="price" ref="price">
    <div class="price-head">
      <div class="name-wrap">
        <span class="name">{{Name}} {{Symbol}}</span>
        <span>分价表</span>
      </div>
    </div>
    <div class="price-content">
      <div class='dealpricelist' v-for="item in [1, 2, 3, 4, 5, 6]" ref='dealpricelist' v-show='DealPriceData && DealPriceData.length > 0' ><!-- 分价表 -->
        <table class='table'>
          <thead>
            <tr>
              <th>价格</th>
              <th>成交量</th>
              <th>比例</th>
              <th>竞买率</th>
            </tr>
          </thead>
          <tbody>
          <tr v-for='(item,index) in DealPriceData' :key='index+"dealprice"'>
            <td :class='item.Price.Color'>{{item.Price.Text}}</td>
            <td>{{item.Vol}}</td>
            <td class="charts">
              <span :style='item.Bar'>
                <span class="buy" :style='item.BuyRate'></span>
                <span class="none" :style='item.NoneRate'></span>
                <span class="sell" :style='item.SellRate'></span>
              </span>
            </td>
            <td>{{item.Rate}}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script>
import urlObj from '~/utils/urlObj'
import $ from "jquery";
import JSCommon from "~/jscommon/umychart.vue/umychart.vue.js";
import JSCommonStock from "~/jscommon/umychart.vue/umychart.stock.vue.js";

const tdHeight = 28;
const minWidth = 200;
export default {
  props: ['Symbol'],
  data () {
    return {
      Name: '',
      DealPrice: {
        Data:null,
        JSStock: null //数据请求控制器
      },
      DealPriceData: null,
      tbodyHeight: 0,
      tbodyWidth: 0
    }
  },
  created() {
    if(!this.Symbol) {
      this.Symbol = '000001.sz';
    }
    this.requestData();
  },
  methods: {
    calculate() {
      this.tbodyHeight = document.body.clientHeight - 32 - 26;
      this.tbodyWidth = document.body.clientWidth - 26;
      let col = Math.floor(this.tbodyHeight / tdHeight);
      let totalRow = Math.floor(this.DealPriceData.length / col);
      let pageRow = Math.floor(this.tbodyWidth / minWidth);
      console.log(totalRow);
      console.log(pageRow);
      if(totalRow < pageRow) {
        console.log('不能分这么多列');
      }else {
        console.log('可以分这么多列');
      };
    },
    requestData() {
      if (!this.DealPrice.JSStock) this.DealPrice.JSStock = JSCommonStock.JSStock.GetDealPriceListData();
      let dealPrice = this.DealPrice.JSStock;
      dealPrice.Symbol=this.Symbol;
      dealPrice.UpdateUICallback = this.UpdateDealPrice;
      dealPrice.IsAutoUpdate = true;
      dealPrice.RequestData();
    },
    UpdateDealPrice:function(dealPrice)  //分价表
    {
      console.log('[StockTradeInfo::UpdateDealPrice]', dealPrice.Data);
      this.Name = dealPrice.Data.Stock.Name;
      var yClose = dealPrice.Data.Day.YClose;
      var priceList = dealPrice.Data.PriceList;
      var maxVol = 0;
      for(let i = 0; i < priceList.length; ++i){
        var item = priceList[i];
        if(item.Vol > maxVol){
          maxVol = item.Vol;
        }
      }
      var tdWPer = 0.25;
      var paddingRight = 5;
      var barWidth = this.$refs.dealpricelist.clientWidth * tdWPer - paddingRight;
      var data = [];
      for(let i = 0; i < priceList.length; ++i){
        var item = priceList[i];
        var vol = item.Vol;
        var buyRate = item.BuyVol / vol;
        var sellRate = item.SellVol / vol;
        var noneRate = item.NoneVol / vol;

        var dealPriceObj = {};

        var barStyle = {width:'20px'};
        dealPriceObj.Price = {Text:JSCommon.IFrameSplitOperator.FormatValueString(item.Price,2),Color:'',Value:item.Price} ;
        dealPriceObj.Vol = parseInt(item.Vol/100);
        dealPriceObj.Rate = JSCommon.IFrameSplitOperator.FormatValueString(item.Proportion * 100, 2) + '%';
        var color = JSCommon.IFrameSplitOperator.FormatValueColor(item.Price,yClose);
        dealPriceObj.Price.Color = color;
        dealPriceObj.WidthRate = item.Vol / maxVol;
        var totalWidth = barWidth * dealPriceObj.WidthRate > 1 ? barWidth * dealPriceObj.WidthRate : 1;
        barStyle.width = totalWidth + 'px';

        var buyWidth = buyRate * totalWidth + 'px';
        var sellWidth = sellRate * totalWidth + 'px';
        var noneWidth = noneRate * totalWidth + 'px';
        dealPriceObj.BuyRate = {width:buyWidth};
        dealPriceObj.SellRate = {width:sellWidth};
        dealPriceObj.NoneRate = {width:noneWidth};

        dealPriceObj.Bar = barStyle;
        data.push(dealPriceObj);
      }
      data.sort( (l,r) => r.Price.Value-l.Price.Value );
      this.DealPriceData = data;
      this.calculate();
    },
  }
}
</script>

<style scoped lang="less" rel="stylesheet/less">
  @captionColor: #919aa3;
  @bgColor: #141718;
  @borderColor: #292d2f;
  @priceUpColor: #ff5c5c;
  @priceDownColor: #39e365;
  @priceNull: #fff;
  @buyBgColor: #ff5c5c;
  @noneBgColor: #71777f;
  @sellBgColor: #39e365;

  @tradingVolColor: #d8dfe7;
  @hoverBgColor: #26384f;

  @minWidth: 200px;
  @maxWidth: 250px;

  .price {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    color: @captionColor;
    background-color: @bgColor;
    overflow: hidden;
    .price-head {
      fonot-size: 16px;
      border-bottom: 1px solid @borderColor;
      box-sizing: border-box;
      text-align: center;
      .name-wrap {
        height: 32px;
        line-height: 32px;
        .name {
          margin-right: 16px;
        }
      }
    }
    .price-content {
      display: flex;
      font-size: 12px;
      flex: 1;
      .dealpricelist {
        width: @minWidth;
        box-sizing: border-box;
        .table {
          width: 100%;
          border-right: 1px solid @borderColor;
          box-sizing: border-box;
          border-collapse: collapse;
          thead {
            th {
              height: 26px;
              line-height: 26px;
              border-bottom: 1px solid @borderColor;
              box-sizing: border-box;
              &:nth-child(even) {
                text-align: right;
              }
              &:nth-child(odd) {
                text-align: left;
              }
              &:first-child {
                padding-left: 10px;
              }
              &:nth-child(2) {
                padding-right: 5px;
              }
              &:nth-child(3) {
                padding-left: 5px;
              }
              &:last-child {
                padding-right: 10px;
              }
            }
          }
          tbody {
            tr {
              &:hover {
                background-color: @hoverBgColor;
              }
              td {
                height: 28px;
                line-height: 28px;
                box-sizing: border-box;
                &:nth-child(even) {
                  text-align: right;
                }
                &:nth-child(odd) {
                  text-align: left;
                }
                &:first-child {
                  padding-left: 10px;
                }
                &:nth-child(2) {
                  color: @tradingVolColor;
                  padding-right: 5px;
                }
                &:nth-child(3) {
                  padding-left: 5px;
                }
                &:last-child {
                  color: @tradingVolColor;
                  padding-right: 10px;
                }
                > span {
                  vertical-align: middle;
                  display: inline-block;
                  height: 14px;
                  > span {
                    display: inline-block;
                    height: 14px;
                  }
                  .buy {
                    background-color: @buyBgColor;
                  }
                  .none {
                    background-color: @noneBgColor;
                  }
                  .sell {
                    background-color: @sellBgColor;
                  }
                }
                &.PriceUp {
                  color: @buyBgColor !important;
                }
                &.PriceNull {
                  color: @noneBgColor !important;
                }
                &.PriceDown {
                  color: @sellBgColor !important;
                }
                &.charts {
                  display: flex;
                  align-items: center;
                  &>span {
                    display: flex;
                    align-items: center;
                  }
                }
              }
            }
          }
        }
      }
    }
  }


</style>